---
title: "NCRN Water R package vignette"
date: "19 Dec 2022"
output: html_notebook
---
This vignette introduces a user to this package, its inputs, outputs, purposes, deliverables, and audiences.

### Installation

NCRNWater is not available on CRAN so it must be installed [Github.](https://github.com/NCRN/NCRNWater).

Two ways to install packages from Github:  
1. `devtools::install_github()` as documented [here.](https://www.rdocumentation.org/packages/devtools/versions/1.13.6/topics/install_github)  
2. `devtools_install_local()` as documented [here.](https://www.rdocumentation.org/packages/devtools/versions/1.13.5/topics/install_local)  

```{r}
# https://github.com/NCRN/NCRNWater
# un-comment your chosen method

# install via devtools::install_github()
# library(devtools)
# devtools::install_github("NCRN/NCRNWater")


# install via .zip of github repo devtools::install_local()
# 1) download .zip of repo # https://stackoverflow.com/questions/2751227/how-to-download-source-in-zip-format-from-github
## put this in your browser: github.com/NCRN/NCRNWater/zipball/master/
# 2) devtools::install_local() # https://stackoverflow.com/questions/17366772/install-r-packages-from-github-downloading-master-zip
# devtools::install_local("NCRNWater.zip")
# renv::install(c('lubridate', 'plotly', 'readr', 'season', 'tidyr', 'tidyverse')) # resolve dependency issues
# devtools::install_local("NCRNWater.zip")
```

If renv conflicts with devtools, [this issue log](https://github.com/NCRN/NCRN_DM/issues/62) may help.

```{r}
# load required libraries
library(NCRNWater)
library(tidyverse)
```

NCRNWater takes two input CSVs called `metadata` and `waterdata` in this vignette.

This is the format of NCRNWater metadata:

```{r}
metadata <- data(metadata) # load the example metadata file
head(metadata)
glimpse(metadata)
```

This is the format of NCRNWater data:

```{r}
waterdata <- read.csv("water_data/waterdata.csv")
head(waterdata)
glimpse(waterdata)
```
* note that `waterdata` dataset is in [wqx format](https://www.waterqualitydata.us/)

### Water object constructor

NCRNWater methods interact with one object class that is constructed with the function `NCRNWater::importNCRNWater()`. To use NCRNWater, you must create an NCRNWater object with `NCRNWater::importNCRNWater()`.

```{r}
waterobj <- NCRNWater::importNCRNWater(Dir = "water_data/", # str; directory in which Data and MetaData are saved (leave blank if in project working directory)
                                       Data = "waterdata.csv", # str; filename of water data
                                       MetaData = "metadata.csv", # str; filename of metadata
                                       wqx = TRUE) # boolean; https://www.waterqualitydata.us/
```

Name the elements of waterobj for convenience.
```{r}
# name the list elements for convenience
for (park in 1:length(waterobj)) {
  names(waterobj)[[park]] <- waterobj[[park]]@ShortName
}
names(waterobj)
```

Access help for NCRNWater functions
```{r}
# NCRNWater::getParks()
?getParks
```

### `get` methods

NCRNWater `analysis` and `visualization` methods accesses data inside a `waterobj` with `get` methods. `get` methods can also be used to parse data from `waterobj`. For example, one could retrieve a list of dataframes where each dataframe is a `charname` (e.g., dissolved oxygen "DOmg") with the code below.

```{r}
# example get method call
cato_sites <- NCRNWater::getSites(object = waterobj, parkcode = "CATO", sitecode = "NCRN_CATO_BGHC")
head(cato_sites[["Catoctin"]]@Characteristics[[1]][[1]]@Data)
```

### `analysis` methods

`NCRNWater::exceed()` summarizes `waterobj` records and returns a dataframe of records that exceed a lower or upper bound for a metric. `NCRNWater::exceed()` has one required argument: object; a NCRNWater water object. For example, returns a dataframe summary of records in in park `CATO` where observed `charname` "DOmg" was below "DOmg" lower limit provided in `metadata.csv`.
```{r}
NCRNWater::exceed(object = waterobj, parkcode = "CATO", charname = "DOmg", lower = subset(metadata, Category == "DOmg")$LowerPoint[1])
```
`NCRNWater::wcosinor()` fits a sin function to data provided in the function arguments. `NCRNWater::wcosinor()` has two required arguments:
1. object; a NCRNWater water object 
2. charname; str; review unique(metadata$CharacteristicName) for `characteristic` choices  

`NCRNWater::wcosinor()` returns three outputs:  
1. R console output with regression coefficients and related informatoin
2. Data frame of dates and predicted values of `charname`. This can be used for plotting E.g., combine this data frame with NCRNWater::waterseries() for a figure showing predicted vs observed.
3. Data frame of outlier observations of `charname` values
```{r}
cosin_results <- NCRNWater::wcosinor(object = waterobj, parkcode = "CATO", charname = "DOmg")
preds <- data.frame(date = head(cosin_results[["PredLine"]][["PreDates.Date"]]),
                    pred = head(cosin_results[["PredLine"]][["Preds"]]))
preds
```


### `visualization` methods

`NCRNWater::waterbox()` produces boxplots with year on the horizontal axis, characteristic on the vertical axis. Data are aggregated at the [parkcode] level. `NCRNWater::waterbox()` has three required arguments:  
1. object; a NCRNWater water object  
2. parkcode; str; 4-letter NPS park code, review for `parkcode` choices:    
```
for (park in 1:length(waterobj))
  print(waterobj[[park]]@ParkCode)
```
3. charname; str; review unique(metadata$CharacteristicName) for `characteristic` choices  
```{r}
NCRNWater::waterbox(object = waterobj, parkcode = "CATO", charname = "DOmg")
```

`NCRNWater::waterheat()` produces a heat map with date on the horizontal axis, with a color band corresponding to each date. Data are aggregated at the [parkcode][sitecode] level. `NCRNWater::waterheat()` has four required arguments:  
1. object; a NCRNWater water object  
2. parkcode; str; 4-letter NPS park code, review for `parkcode` choices:    
```
for (park in 1:length(waterobj))
  print(waterobj[[park]]@ParkCode)
```
3. sitecode; str; review for `sitecode` choices:
```
for (park in 1:length(waterobj))
  for (site in 1:length(waterobj[[park]]@Sites))
    print(waterobj[[park]]@Sites[[site]]@SiteCode)
```
3. charname; str; review unique(metadata$CharacteristicName) for `characteristic` choices  
```{r}
NCRNWater::waterheat(object = waterobj, parkcode = "CATO", sitecode = "NCRN_CATO_BGHC", charname = "DOmg", years = 2018)
```

`NCRNWater::waterseries()` produces a scatterplot with date on the horizontal axis and the value of the `charname` parameter on the vertical axis. Data are aggrated at the [parkcode] level.`NCRNWater::waterheat()` has three required arguments:  
1. object; a NCRNWater water object  
2. parkcode; str; 4-letter NPS park code, review for `parkcode` choices:    
```
for (park in 1:length(waterobj))
  print(waterobj[[park]]@ParkCode)
```
3. charname; str; review unique(metadata$CharacteristicName) for `characteristic` choices  

```{r}
NCRNWater::waterseries(object = waterobj, parkcode = "CATO", charname = "DOmg")
```

